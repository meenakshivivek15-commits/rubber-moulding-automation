name: Full Business Flow CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      LEGACY_URL: ${{ secrets.LEGACY_URL }}
      PLANNER_URL: ${{ secrets.PLANNER_URL }}
      PPA_USER: ${{ secrets.PPA_USER }}
      PPA_PASSWORD: ${{ secrets.PPA_PASSWORD }}
      PPA_COMPANY: ${{ secrets.PPA_COMPANY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Root Dependencies
        run: npm ci

      - name: Install Web App Dependencies
        run: |
          cd web-app-automation
          npm ci
      - name: Install Mobile Dependencies
        run: |
          cd mobile-automation
          npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Full Business Flow (with Android Emulator)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel
          emulator-options: -no-window -no-audio -no-boot-anim -gpu off -no-snapshot-load -no-snapshot-save
          disable-animations: true
          script: |
            set -eu

            echo "===== ADB DEVICES ====="
            adb devices

            adb wait-for-device

            i=1; while [ "$i" -le 60 ]; do BOOT_COMPLETED=$(adb shell getprop sys.boot_completed | tr -d '\r'); if [ "$BOOT_COMPLETED" = "1" ]; then echo "Emulator boot completed ✅"; break; fi; sleep 2; i=$((i+1)); done

            EMULATOR_SERIAL=$(adb devices | awk '/emulator-[0-9]+[[:space:]]+device/{print $1; exit}')
            if [ -z "$EMULATOR_SERIAL" ]; then
              echo "No online emulator found ❌"
              adb devices
              exit 1
            fi

            echo "Using ANDROID_SERIAL=$EMULATOR_SERIAL"
            export ANDROID_SERIAL="$EMULATOR_SERIAL"
            export USE_EXTERNAL_APPIUM=true

            npx appium driver install uiautomator2
            npx appium --address 127.0.0.1 --port 4723 --base-path / --relaxed-security > appium.log 2>&1 &
            APPIUM_PID=$!

            i=1; while [ "$i" -le 45 ]; do if curl -fsS http://127.0.0.1:4723/status >/dev/null; then echo "Appium is ready ✅"; break; fi; sleep 2; i=$((i+1)); done

            adb start-server
            adb devices
            CURRENT_SERIAL=$(adb devices | awk '/emulator-[0-9]+[[:space:]]+device/{print $1; exit}')
            if [ -z "$CURRENT_SERIAL" ]; then
              echo "No online emulator found right before full:e2e ❌"
              adb devices
              tail -n 200 appium.log || true
              exit 1
            fi
            export ANDROID_SERIAL="$CURRENT_SERIAL"
            echo "Using ANDROID_SERIAL=$ANDROID_SERIAL"

            set +e
            npm run full:e2e
            TEST_EXIT_CODE=$?
            set -e

            kill $APPIUM_PID || true
            exit $TEST_EXIT_CODE