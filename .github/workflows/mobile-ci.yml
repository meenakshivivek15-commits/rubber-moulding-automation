name: Mobile Automation CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  mobile-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      APPIUM_HOME: ${{ github.workspace }}/.appium

    steps:

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('mobile-automation/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: mobile-automation/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('mobile-automation/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install Mobile Dependencies
        working-directory: mobile-automation
        run: npm ci

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Run tests on Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel
          emulator-options: -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -no-snapshot
          disable-animations: true
          script: |
            adb start-server
            adb devices -l
            adb wait-for-device
            until [ "$(adb shell getprop sys.boot_completed | tr -d '\r')" = "1" ]; do
              sleep 5
            done
            adb shell input keyevent 82 || true
            export ANDROID_SERIAL="$(adb devices | awk '/^emulator-[0-9]+[[:space:]]+device$/{print $1; exit}' | tr -d '\r')"
            echo "Detected emulator serial: ${ANDROID_SERIAL}"
            if [ -z "${ANDROID_SERIAL}" ]; then
              echo "No emulator serial detected from adb devices"
              adb devices -l
              exit 1
            fi
            for i in {1..30}; do
              STATE="$(adb -s "${ANDROID_SERIAL}" get-state 2>/dev/null | tr -d '\r')"
              BOOTED="$(adb -s "${ANDROID_SERIAL}" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')"
              if [ "${STATE}" = "device" ] && [ "${BOOTED}" = "1" ]; then
                break
              fi
              sleep 2
            done
            adb -s "${ANDROID_SERIAL}" get-state
            adb -s "${ANDROID_SERIAL}" shell getprop sys.boot_completed
            export ANDROID_SDK_ROOT="$(dirname "$(dirname "$(command -v adb)")")"
            export ANDROID_HOME="${ANDROID_SDK_ROOT}"
            export PATH="${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:${PATH}"
            echo "ANDROID_SDK_ROOT=${ANDROID_SDK_ROOT}"
            which adb
            adb version
            cd mobile-automation
            npx appium driver list --installed || true
            npx appium driver install uiautomator2
            npx appium driver list --installed
            mkdir -p ../reports/mobile/diagnostics
            until [ "$(adb -s "${ANDROID_SERIAL}" get-state 2>/dev/null | tr -d '\r')" = "device" ]; do
              sleep 2
            done
            npx appium --address 127.0.0.1 --port 4723 --base-path / --relaxed-security > ../reports/mobile/diagnostics/appium.log 2>&1 &
            APPIUM_PID=$!
            until curl -s http://127.0.0.1:4723/status >/dev/null; do
              sleep 2
            done
            echo "Pre-WDIO adb state for ${ANDROID_SERIAL}:"
            adb devices -l
            adb -s "${ANDROID_SERIAL}" get-state
            set +e
            ANDROID_SERIAL="${ANDROID_SERIAL}" ANDROID_HOME="${ANDROID_HOME}" ANDROID_SDK_ROOT="${ANDROID_SDK_ROOT}" DEVICE=emulator CI=true EXTERNAL_APPIUM=true npx wdio run config/wdio.qa.conf.ts
            TEST_EXIT_CODE=$?
            if [ $TEST_EXIT_CODE -ne 0 ]; then
              adb devices -l > ../reports/mobile/diagnostics/adb-devices.txt || true
              adb shell getprop > ../reports/mobile/diagnostics/device-props.txt || true
              adb logcat -d > ../reports/mobile/diagnostics/logcat.txt || true
            fi
            kill $APPIUM_PID || true
            exit $TEST_EXIT_CODE

      - name: Install Allure
        run: npm install -g allure-commandline

      - name: Generate Allure Report
        run: |
          # Generate report from the test results produced by WDIO
          allure generate mobile-automation/allure-results \
          --clean \
          -o reports/mobile/allure-report

      - name: Upload Allure Report
        uses: actions/upload-artifact@v4
        with:
          name: mobile-allure-report
          path: reports/mobile/allure-report

      - name: Upload raw Allure results
        uses: actions/upload-artifact@v4
        with:
          name: mobile-allure-results
          path: mobile-automation/allure-results

      - name: Upload mobile diagnostics (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mobile-diagnostics
          path: reports/mobile/diagnostics
          if-no-files-found: ignore

